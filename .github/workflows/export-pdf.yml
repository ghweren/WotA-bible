name: Export to PDF
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  export:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install pandoc and LaTeX
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-latex-base texlive-fonts-recommended texlive-fonts-extra texlive-latex-extra
      
      - name: Generate PDF with pandoc
        run: |
          # Собираем все markdown файлы в один, очищая от YAML frontmatter
          find . -name "*.md" -type f | sort > filelist.txt
          
          # Создаем общий файл с явным заголовком
          echo "# Project Documentation" > combined.md
          echo "" >> combined.md
          echo "*Generated on $(date)*" >> combined.md
          echo "" >> combined.md
          echo "---" >> combined.md
          echo "" >> combined.md
          
          while IFS= read -r file; do
            echo "## File: $file" >> combined.md
            echo "" >> combined.md
            
            # Удаляем YAML frontmatter (строки между --- и ---)
            # и добавляем содержимое файла
            awk '/^---$/ && ++count % 2 {next} count % 2 == 0' "$file" >> combined.md
            
            echo "" >> combined.md
            echo "---" >> combined.md
            echo "" >> combined.md
          done < filelist.txt
          
          # Конвертируем в PDF с помощью pandoc
          pandoc combined.md -o project-bible.pdf \
            --pdf-engine=xelatex \
            -V geometry:margin=2cm \
            -V colorlinks=true \
            -V linkcolor=blue \
            -V urlcolor=blue \
            --toc \
            --toc-depth=3 \
            -M title="Project Documentation" \
            -M author="Automated Export"
          
          # Альтернативная команда с явным отключением YAML метаданных
          if [ ! -f "project-bible.pdf" ]; then
            echo "Trying alternative approach..."
            pandoc combined.md -o project-bible.pdf \
              --standalone \
              --pdf-engine=xelatex \
              -V geometry:margin=2cm \
              --metadata title="Project Documentation" \
              --metadata author="Automated Export"
          fi
          
      - name: Verify PDF generation
        run: |
          if [ ! -f "project-bible.pdf" ]; then
            echo "PDF file was not generated!"
            echo "Checking combined.md content..."
            head -20 combined.md
            exit 1
          fi
          echo "PDF generated successfully. Size: $(stat -c%s project-bible.pdf) bytes"
          
      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: project-bible-pdf
          path: project-bible.pdf