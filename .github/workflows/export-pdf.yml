name: Export to PDF
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  export:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended texlive-fonts-extra fonts-liberation wkhtmltopdf
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js –¥–ª—è markdown-it
          npm install markdown-it fs-extra
      
      - name: Generate PDF
        run: |
          # –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ HTML –∏–∑ –≤—Å–µ—Ö markdown —Ñ–∞–π–ª–æ–≤
          cat > generate-html.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const MarkdownIt = require('markdown-it');
          
          const md = new MarkdownIt({
            html: true,
            linkify: true,
            typographer: true
          });
          
          // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ markdown —Ñ–∞–π–ª–æ–≤
          function findMarkdownFiles(dir, fileList = []) {
            const items = fs.readdirSync(dir);
            
            for (const item of items) {
              const fullPath = path.join(dir, item);
              const stat = fs.statSync(fullPath);
              
              // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º .git –∏ node_modules
              if (item === '.git' || item === 'node_modules' || item === '.github') {
                continue;
              }
              
              if (stat.isDirectory()) {
                findMarkdownFiles(fullPath, fileList);
              } else if (item.endsWith('.md')) {
                fileList.push(fullPath);
              }
            }
            return fileList;
          }
          
          // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ markdown —Ñ–∞–π–ª—ã
          const allFiles = findMarkdownFiles('.');
          
          // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø—É—Ç–∏ –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
          allFiles.sort();
          
          // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ YAML frontmatter
          function removeYamlFrontmatter(content) {
            if (content.startsWith('---\n')) {
              const lines = content.split('\n');
              let inFrontmatter = false;
              let frontmatterEnd = 0;
              
              for (let i = 0; i < lines.length; i++) {
                if (lines[i] === '---') {
                  if (!inFrontmatter) {
                    inFrontmatter = true;
                  } else {
                    frontmatterEnd = i;
                    break;
                  }
                }
              }
              
              if (frontmatterEnd > 0) {
                return lines.slice(frontmatterEnd + 1).join('\n');
              }
            }
            return content;
          }
          
          // –°–æ–∑–¥–∞–µ–º HTML –¥–æ–∫—É–º–µ–Ω—Ç
          let html = `
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <title>WotA Project Bible</title>
              <style>
                  body {
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                      line-height: 1.6;
                      margin: 2cm;
                      color: #333;
                  }
                  h1 {
                      color: #2c3e50;
                      border-bottom: 3px solid #3498db;
                      padding-bottom: 10px;
                  }
                  h2 {
                      color: #34495e;
                      border-bottom: 1px solid #bdc3c7;
                      padding-bottom: 5px;
                      margin-top: 30px;
                  }
                  h3 {
                      color: #46637f;
                  }
                  .file-header {
                      background: linear-gradient(to right, #f8f9fa, #e9ecef);
                      padding: 15px;
                      border-left: 5px solid #3498db;
                      margin: 25px 0;
                      border-radius: 0 5px 5px 0;
                  }
                  .file-path {
                      font-family: 'Courier New', monospace;
                      font-size: 0.9em;
                      color: #7f8c8d;
                      margin-bottom: 10px;
                  }
                  pre {
                      background-color: #f8f9fa;
                      border: 1px solid #dee2e6;
                      border-radius: 4px;
                      padding: 15px;
                      overflow-x: auto;
                  }
                  code {
                      background-color: #f8f9fa;
                      padding: 2px 6px;
                      border-radius: 3px;
                      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
                  }
                  blockquote {
                      border-left: 4px solid #3498db;
                      margin: 20px 0;
                      padding: 10px 20px;
                      background-color: #f8f9fa;
                  }
                  table {
                      border-collapse: collapse;
                      width: 100%;
                      margin: 20px 0;
                  }
                  th, td {
                      border: 1px solid #dee2e6;
                      padding: 8px 12px;
                      text-align: left;
                  }
                  th {
                      background-color: #f8f9fa;
                      font-weight: bold;
                  }
                  tr:nth-child(even) {
                      background-color: #f8f9fa;
                  }
                  .toc {
                      background-color: #f8f9fa;
                      padding: 20px;
                      border-radius: 5px;
                      margin-bottom: 30px;
                  }
                  .toc ul {
                      list-style-type: none;
                      padding-left: 20px;
                  }
                  .toc li {
                      margin: 5px 0;
                  }
                  .page-break {
                      page-break-after: always;
                  }
                  hr {
                      border: none;
                      border-top: 2px dashed #bdc3c7;
                      margin: 40px 0;
                  }
              </style>
          </head>
          <body>
              <h1>WotA Project Bible</h1>
              <p><em>Complete project documentation - Generated on ${new Date().toLocaleDateString()}</em></p>
              
              <div class="toc">
                  <h2>Table of Contents</h2>
                  <ul>
          `;
          
          // –î–æ–±–∞–≤–ª—è–µ–º –æ–≥–ª–∞–≤–ª–µ–Ω–∏–µ
          allFiles.forEach((file, index) => {
            const relativePath = file.replace(/^\.\//, '');
            html += `<li><a href="#file-${index}">${relativePath}</a></li>`;
          });
          
          html += `
                  </ul>
              </div>
              
              <hr>
          `;
          
          // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª
          allFiles.forEach((file, index) => {
            console.log(`Processing: ${file}`);
            
            try {
              const content = fs.readFileSync(file, 'utf8');
              const cleanContent = removeYamlFrontmatter(content);
              const relativePath = file.replace(/^\.\//, '');
              
              html += `
              <div class="file-header">
                  <div class="file-path">${relativePath}</div>
                  <h2 id="file-${index}">${path.basename(file, '.md')}</h2>
              </div>
              
              ${md.render(cleanContent)}
              `;
              
              // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É —Ñ–∞–π–ª–∞–º–∏, –Ω–æ –Ω–µ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ
              if (index < allFiles.length - 1) {
                html += '<hr>';
              }
              
            } catch (error) {
              console.error(`Error processing ${file}:`, error.message);
              html += `<div class="file-header"><h2>Error processing: ${file}</h2><p>${error.message}</p></div>`;
            }
          });
          
          html += `
          </body>
          </html>
          `;
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º HTML
          fs.writeFileSync('combined.html', html);
          console.log(`Generated HTML with ${allFiles.length} files`);
          EOF
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é HTML
          node generate-html.js
          
          # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º HTML –≤ PDF —Å –ø–æ–º–æ—â—å—é wkhtmltopdf
          echo "Converting HTML to PDF..."
          wkhtmltopdf \
            --page-size A4 \
            --margin-top 20mm \
            --margin-bottom 20mm \
            --margin-left 20mm \
            --margin-right 20mm \
            --header-center "WotA Project Bible" \
            --header-font-size 10 \
            --header-spacing 5 \
            --footer-center "Page [page] of [topage]" \
            --footer-font-size 10 \
            --footer-spacing 5 \
            --enable-local-file-access \
            combined.html project-bible.pdf
          
          # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: –∏—Å–ø–æ–ª—å–∑—É–µ–º pandoc –µ—Å–ª–∏ wkhtmltopdf –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
          if [ ! -f "project-bible.pdf" ] || [ ! -s "project-bible.pdf" ]; then
            echo "Trying pandoc as fallback..."
            # –°–Ω–∞—á–∞–ª–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º HTML –≤ markdown –¥–ª—è pandoc
            pandoc combined.html -o combined-clean.md
            pandoc combined-clean.md -o project-bible.pdf \
              --pdf-engine=xelatex \
              -V geometry:margin=2cm \
              -V mainfont="DejaVu Sans" \
              --toc \
              --toc-depth=3 \
              -M title="WotA Project Bible"
          fi
      
      - name: Verify PDF generation
        run: |
          if [ ! -f "project-bible.pdf" ]; then
            echo "‚ùå PDF file was not generated!"
            echo "Checking generated files..."
            ls -la *.html *.pdf || true
            exit 1
          fi
          
          PDF_SIZE=$(stat -c%s project-bible.pdf)
          echo "‚úÖ PDF generated successfully"
          echo "üìÑ File size: $PDF_SIZE bytes"
          echo "üìÑ Number of pages: $(pdfinfo project-bible.pdf 2>/dev/null | grep 'Pages:' | awk '{print $2}' || echo 'unknown')"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ PDF –Ω–µ –ø—É—Å—Ç–æ–π
          if [ "$PDF_SIZE" -lt 1000 ]; then
            echo "‚ö†Ô∏è  Warning: PDF file is very small ($PDF_SIZE bytes), might be empty"
          fi
      
      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: wota-project-bible
          path: project-bible.pdf
      
      - name: Upload HTML for debugging
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: html-debug
          path: combined.html